<!DOCTYPE html>
<html lang="zh-CN">

  <head>
  <meta charset="utf-8">
  <meta name="author" content="zchengsite, 1451426471@qq.com" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  
  <title>64bit 멀티코어 OS 원리와 구조 - Day 5   | GOMI🏝️LAND</title>

  
    <link rel="apple-touch-icon" href="/images/favicon.ico">
    <link rel="icon" href="/images/favicon.ico">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Raleway&display=swap" rel="stylesheet">

  <!-- hexo site css -->
  
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/iconfont/iconfont.css">
<link rel="stylesheet" href="/css/github-markdown.css">
<link rel="stylesheet" href="/css/highlight.css">


  <!-- jquery3.3.1 -->
  <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

  <!-- fancybox -->
  <link href="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.css" rel="stylesheet">
  <script async src="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  
<script src="/js/fancybox.js"></script>


  

<meta name="generator" content="Hexo 5.2.0"></head>


  <body>
    <div id="app">
      <div class="header">
  <div class="avatar">
    <a href="/">
      <!-- 头像取消懒加载，添加no-lazy -->
      
        <img src="/images/avatar.png" alt="">
      
    </a>
    <div class="nickname"><a href="/">juraffe</a></div>
  </div>
  <div class="navbar">
    <ul>
      
        <li class="nav-item" data-path="/">
          <a href="/">Home</a>
        </li>
      
        <li class="nav-item" data-path="/archives/">
          <a href="/archives/">Archives</a>
        </li>
      
        <li class="nav-item" data-path="/tags/">
          <a href="/tags/">Tags</a>
        </li>
      
        <li class="nav-item" data-path="/friends/">
          <a href="/friends/">Friends</a>
        </li>
      
        <li class="nav-item" data-path="/about/">
          <a href="/about/">About</a>
        </li>
      
    </ul>
  </div>
</div>


<script src="/js/activeNav.js"></script>



      <div class="flex-container">
        <!-- 文章详情页，展示文章具体内容，url形式：https://yoursite/文章标题/ -->
<!-- 同时为「标签tag」，「朋友friend」，「分类categories」，「关于about」页面的承载页面，具体展示取决于page.type -->



  

  

  

  
  <!-- 文章内容页 url形式：https://yoursite/文章标题/ -->
  <div class="container post-details" id="post-details">
    <div class="post-content">
      <div class="post-title">64bit 멀티코어 OS 원리와 구조 - Day 5</div>
      <div class="post-attach">
        <span class="post-pubtime">
          <i class="iconfont icon-updatetime" title="Update time"></i>
          2020-05-15
        </span>
        
              <span class="post-tags">
                <i class="iconfont icon-tags" title="Tags"></i>
                
                <span class="span--tag">
                  <a href="/tags/os/" title="os">
                    <b>#</b> os
                  </a>
                </span>
                
                <span class="span--tag">
                  <a href="/tags/kernel/" title="kernel">
                    <b>#</b> kernel
                  </a>
                </span>
                
              </span>
          
      </div>
      <div class="markdown-body">
        <blockquote>
<p>이 글은 ‘64비트 멀티코어 OS 원리와 구조 - 한승훈 저자’을 공부하며 정리한 내용을 작성했습니다.</p>
</blockquote>
<h1 id="페이지-기능을-활성화하여-64비트-전환-준비"><a href="#페이지-기능을-활성화하여-64비트-전환-준비" class="headerlink" title="페이지 기능을 활성화하여 64비트 전환 준비"></a>페이지 기능을 활성화하여 64비트 전환 준비</h1><h2 id="선형-주소와-4단계-페이징-기법"><a href="#선형-주소와-4단계-페이징-기법" class="headerlink" title="선형 주소와 4단계 페이징 기법"></a>선형 주소와 4단계 페이징 기법</h2><p>페이징에 사용하는 각 테이블은 512개의 엔트리로 구성되며 다음 레벨에서 사용할 테이블의 기준 주소를 포함한다. 그리고 가장 마지막 레벨인 페이지 디렉터리의 엔트리는 2MB 페이지의 기준 주소를 포함한다.</p>
<blockquote>
<p>책 P.250 내용에 포함된 사진을 보시면 이해가 쉽습니다.</p>
</blockquote>
<p>선형 주소를 실제 물리 주소로 변환하는 과정은 CR3 레지스터에 설정된 PML4 테이블의 기준 주소로 PML4 엔트리 -&gt; 페이지 디렉터리 포인터 엔트리 -&gt; 디렉터리 엔트리로 진행하여 2MB 페이지의 기준 주소를 찾은 다음 선형 주소의 하위 21비트 오프셋을 더하면 된다.</p>
<p>이 과정에서 알 수 있듯이 PML4(Page Map Level 4)에서는 (1)PML4 테이블, (2)페이지 디렉터리 포인터 테이블, (3) 페이지 디렉터리 등 세 가지 자료구조를 생성해야 한다. 각 테이블은 8바이트로 구성되며 각 엔트리는 다음 레벨 테이블의 기준 주소외에도 다양한 필드를 포함한다.</p>
<h2 id="페이지-테이블-구성과-공간-할당"><a href="#페이지-테이블-구성과-공간-할당" class="headerlink" title="페이지 테이블 구성과 공간 할당"></a>페이지 테이블 구성과 공간 할당</h2><p>MINT64 OS는 2MB 크기의 페이지를 사용해 최대 64GB의 물리 메모리를 매핑한다고 하면, <code>페이지 디렉터리</code>는 <code>8바이트</code> 크기의 엔트리 512개로 구성되며 각 엔트리는 2MB 페이지에 대한 정보를 담고 있다. 따라서 한 페이지 디렉터리는 2MB x 512개로 <code>1GB</code>이며 하나의 페이지 디렉터리는 8바이트 x 512개로 <code>4KB</code>의 메모리를 차지한다. 총 64GB를 관리하기 위해서는 4KB의 페이지 디렉터리 64개가 필요하니 총 <code>256KB</code>가 된다.</p>
<p>앞서 페이지 디렉터리의 포인터를 가지고 있는 <code>페이지 디렉터리 포인터 테이블</code> 역시 페이지 디렉터리와 마찬가지로 8바이트 크기의 엔트리 512개로 구성되고 앞서 페이지 디렉터리 64개를 관리하기 위해서 총 64개의 필드가 필요하다. 64개의 크기는 기존 512개로 충분히 커버가 가능하기 때문에 총 4KB(기본 크기)가 필요하다.</p>
<p>페이지 디렉터리 포인터 테이블을 가리키는 <code>PML4 테이블</code>은 다른 테이블과 마찬가지로 8바이트 크기인 PML4 테이블 엔트리 512개로 구성되며 각 엔트리는 페이지 디렉터리 포인터 테이블의 정보를 담고 있다. 때문에 앞서 페이지 디렉터리 포인터 테이블을 관리하기 위해선 1개의 엔트리만 있으면 되며, 기본 크기 4KB가 필요하다.</p>
<p>이로써 총 264KB의 메모리가 필요하며 이 크기는 지금까지 만든 OS 이미지가 5KB가 안된다는걸 생각하면 큰 크기이다. 이런 큰 크기의 메모리를 이미지에 포함한다면 부팅시간이 지연되고, 4KB로 정렬하기 위해서 추가적으로 불필요한 공간이 낭비된다.</p>
<p>이 문제를 해결하기 위해서 MINTOS64에서는 IA-32e 모드 커널을 0x200000(2MB)주소에 복사했고 그 이전의 0x100000(1MB)~0x200000(2MB)까지의 메모리 영역을 비워뒀다. 이곳에 PML4, 페이지 디렉터리 포인터 테이블, 페이지 디렉터리를 순서대로 위치시킨다.</p>
<h3 id="공통-속성-필드-설정"><a href="#공통-속성-필드-설정" class="headerlink" title="공통 속성 필드 설정"></a>공통 속성 필드 설정</h3><p>PML4 테이블 엔트리, 페이지 디렉터리 포인터 엔트리, 페이지 디렉터리 엔트리는 공통적인 속성을 가지고 각 속성은 다음과 같다.</p>
<ul>
<li>A, P, Avail, EXB<ul>
<li>MINT64 OS에선 기본 기능외에 다른 기능은 사용하지 않는다. 따라서 EXB(코드 실행 제한), A(메모리 접근), Avail(커널 임시 영역 사용)를 0으로 설정한다. 하지만 P 필드는 해당 엔트리의 유효성을 나타내므로 반드시 1로 설정한다.</li>
</ul>
</li>
<li>PCD와 PWT<ul>
<li>IA-32e 모드 커널은 보호 모드 커널과 달리 실제 OS를 구성하는 핵심 역할이며 속도 향상을 위해서 캐시를 사용한다. 캐시 정책은 Write-Through와 Write-Back 방식이 있지만 Write-Back이 더 효율적이다. 따라서 PCD와 PWT 비트를 설정해 Write-Back 방식을 사용하게 한다.</li>
</ul>
</li>
<li>U/S와 R/W<ul>
<li>MINT64 OS는 유저레벨과 커널레벨을 구분하여 잘못된 접근을 막아 보호해야 한다. 하지만 현재는 유저레벨이 존재하지 않기 때문에 코드 영역, 데이터 영역등을 따로 구분하지 않고 모든 영역을 커널 레벨 영역으로 지정하고 읽기와 쓰기가 가능하게 설정한다.</li>
</ul>
</li>
</ul>
<h3 id="프로세서의-페이징-기능-활성화"><a href="#프로세서의-페이징-기능-활성화" class="headerlink" title="프로세서의 페이징 기능 활성화"></a>프로세서의 페이징 기능 활성화</h3><p>페이징 기능을 활성화 하기 위해서는 CR0의 PG, CR3와 CR4 레지스터의 PAE를 설정할 필요가 있다.</p>
<p>PG비트는 CR0의 최상위 비트이며 PG를 설정하는 순간 페이징 기능이 활성화되기 때문에 설정하기 전 CR3 레지스터의 PML4 테이블의 주소를 설정해야한다. 여기서 추가적으로 CR2 레지스터는 페이지 접근 또는 오류가 발생했을때 예외처리를 하는 역할을 담당한다.</p>
<p>보호 모드에서의 3단계 페이징 기능을 사용하는것이 목적이라면 CR0, CR3레지스터로 충분하지만, 우리의 최종목적은 IA-32e 모드에서 동작하며 2MB의 크기를 가지는 페이징 활성화며 프로세스에 통지하는것이다. 이런 작업을 CR4 레지스터의 PAE(Physical Address Extensions) 비트와 페이지 디렉터리 엔트리의 PS 비트를 1로 설정하여 처리한다. 따라서 페이징 기능 활성화를 위해 레지스터를 CR4-&gt;CR3-&gt;CR0 순으로 설정하는게 좋다.</p>

      </div>
      
        <div class="prev-or-next">
          <div class="post-foot-next">
            
              <a href="/2020/05/07/raspberry-install/" target="_self">
                <i class="iconfont icon-chevronleft"></i>
                <span>Prev</span>
              </a>
            
          </div>
          <div class="post-attach">
            <span class="post-pubtime">
              <i class="iconfont icon-updatetime" title="Update time"></i>
              2020-05-15
            </span>
            
                  <span class="post-tags">
                    <i class="iconfont icon-tags" title="Tags"></i>
                    
                    <span class="span--tag">
                      <a href="/tags/os/" title="os">
                        <b>#</b> os
                      </a>
                    </span>
                    
                    <span class="span--tag">
                      <a href="/tags/kernel/" title="kernel">
                        <b>#</b> kernel
                      </a>
                    </span>
                    
                  </span>
              
          </div>
          <div class="post-foot-prev">
            
              <a href="/2020/06/10/basic-dp-algorithm/" target="_self">
                <span>Next</span>
                <i class="iconfont icon-chevronright"></i>
              </a>
            
          </div>
        </div>
      
    </div>
    
  <div class="post-catalog" id="catalog">
    <div class="title">Contents</div>
    <div class="catalog-content">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%ED%8E%98%EC%9D%B4%EC%A7%80-%EA%B8%B0%EB%8A%A5%EC%9D%84-%ED%99%9C%EC%84%B1%ED%99%94%ED%95%98%EC%97%AC-64%EB%B9%84%ED%8A%B8-%EC%A0%84%ED%99%98-%EC%A4%80%EB%B9%84"><span class="toc-text">페이지 기능을 활성화하여 64비트 전환 준비</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%EC%84%A0%ED%98%95-%EC%A3%BC%EC%86%8C%EC%99%80-4%EB%8B%A8%EA%B3%84-%ED%8E%98%EC%9D%B4%EC%A7%95-%EA%B8%B0%EB%B2%95"><span class="toc-text">선형 주소와 4단계 페이징 기법</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%ED%8E%98%EC%9D%B4%EC%A7%80-%ED%85%8C%EC%9D%B4%EB%B8%94-%EA%B5%AC%EC%84%B1%EA%B3%BC-%EA%B3%B5%EA%B0%84-%ED%95%A0%EB%8B%B9"><span class="toc-text">페이지 테이블 구성과 공간 할당</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%EA%B3%B5%ED%86%B5-%EC%86%8D%EC%84%B1-%ED%95%84%EB%93%9C-%EC%84%A4%EC%A0%95"><span class="toc-text">공통 속성 필드 설정</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%ED%94%84%EB%A1%9C%EC%84%B8%EC%84%9C%EC%9D%98-%ED%8E%98%EC%9D%B4%EC%A7%95-%EA%B8%B0%EB%8A%A5-%ED%99%9C%EC%84%B1%ED%99%94"><span class="toc-text">프로세서의 페이징 기능 활성화</span></a></li></ol></li></ol></li></ol>
    </div>
  </div>

  
<script src="/js/catalog.js"></script>




    
      <div class="comments-container">
        





      </div>
    
  </div>


        <div class="footer">
  <div class="social">
    <ul>
      
        <li>
          <a title="github" target="_blank" rel="noopener" href="https://github.com/aid95">
            <i class="iconfont icon-github"></i>
          </a>
        </li>
      
        <li>
          <a title="email" href="">
            <i class="iconfont icon-envelope"></i>
          </a>
        </li>
      
        <li>
          <a title="facebook" href="">
            <i class="iconfont icon-facebooksquare"></i>
          </a>
        </li>
      
        <li>
          <a title="twitter" target="_blank" rel="noopener" href="https://twitter.com/ju_raffe_">
            <i class="iconfont icon-twitter"></i>
          </a>
        </li>
      
        <li>
          <a title="wechat" href="">
            <i class="iconfont icon-wechat"></i>
          </a>
        </li>
      
        <li>
          <a title="weibo" href="">
            <i class="iconfont icon-weibo"></i>
          </a>
        </li>
      
        <li>
          <a title="rss" href="/atom.xml">
            <i class="iconfont icon-rss"></i>
          </a>
        </li>
      
    </ul>
  </div>
  
    <div class="footer-more">
      <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Copyright © Oranges 2020</a>
    </div>
  
    <div class="footer-more">
      <a target="_blank" rel="noopener" href="https://github.com/zchengsite/hexo-theme-oranges">Theme by Oranges | Powered by Hexo</a>
    </div>
  
</div>

      </div>

      <div class="back-to-top hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



      
  <div class="search-icon" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-title">
        <span class="search-icon-input">
          <a href="javascript: void(0)">
            <i class="iconfont icon-search"></i>
          </a>
        </span>
        
          <input type="text" class="search-input" id="search-input" placeholder="Search...">
        
        <span class="search-close-icon" id="search-close-icon">
          <a href="javascript: void(0)">
            <i class="iconfont icon-close"></i>
          </a>
        </span>
      </div>
      <div class="search-result" id="search-result"></div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    inputArea.onclick = function() {
      getSearchFile()
      this.onclick = null
    }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        // inputArea.focus()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'>First search, index file loading, please wait...<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='" + data_url + "' class='search-result-title'>" + orig_data_title + "</a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<p class=\"search-result-abstract\">" + match_content + "...</p>"
                }
                str += "</li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>No result<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The search.xml file was not found, please refer to：<a href='https://github.com/zchengsite/hexo-theme-oranges#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The request failed, Try to refresh the page or try again later.<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




    </div>
  </body>
</html>
