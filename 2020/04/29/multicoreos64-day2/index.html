<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/icons/favicon-16x16.png?v=2.6.2" type="image/png" sizes="16x16"><link rel="icon" href="/images/icons/favicon-32x32.png?v=2.6.2" type="image/png" sizes="32x32"><meta name="description" content="이 글은 ‘64비트 멀티코어 OS 원리와 구조 - 한승훈 저자’을 공부하며 정리한 내용을 작성했습니다.                      이미지 로딩 구현       책에서 구현하게 될 OS는 부트 로더, 보호 모드 커널, IA-32e 모드 커널로 구성되고 섹터 단위로 정렬되 하나의 부팅 이미지로 만들어지며 두 번째 섹터부터 읽어 메모리에 복사하면 이">
<meta property="og:type" content="article">
<meta property="og:title" content="64bit 멀티코어 OS 원리와 구조 - Day 2">
<meta property="og:url" content="https://blog.gomi.land/2020/04/29/multicoreos64-day2/index.html">
<meta property="og:site_name" content="GOMI🏝️LAND">
<meta property="og:description" content="이 글은 ‘64비트 멀티코어 OS 원리와 구조 - 한승훈 저자’을 공부하며 정리한 내용을 작성했습니다.                      이미지 로딩 구현       책에서 구현하게 될 OS는 부트 로더, 보호 모드 커널, IA-32e 모드 커널로 구성되고 섹터 단위로 정렬되 하나의 부팅 이미지로 만들어지며 두 번째 섹터부터 읽어 메모리에 복사하면 이">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2020-04-29T09:35:15.000Z">
<meta property="article:modified_time" content="2020-12-11T07:34:22.247Z">
<meta property="article:author" content="Byeongju Shin(aka. juraffe)">
<meta property="article:tag" content="os">
<meta property="article:tag" content="kernel">
<meta name="twitter:card" content="summary"><title>64bit 멀티코어 OS 원리와 구조 - Day 2 | GOMI🏝️LAND</title><link ref="canonical" href="https://blog.gomi.land/2020/04/29/multicoreos64-day2/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.6.2"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@400;700;800&amp;display=swap"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  assistSearch: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: {"enable":true},
  back2top: {"enable":true},
  codeblock: {"style":"default","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"Copy","copySuccess":"Copy Success","copyError":"Copy Error"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.2.0"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">Home</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">Archives</span></a></div></div><div class="header-nav-mode"><div class="mode"><div class="mode-track"><span class="mode-track-moon"></span><span class="mode-track-sun"></span></div><div class="mode-thumb"></div></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">GOMI🏝️LAND</div><div class="header-banner-info__subtitle"></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">64bit 멀티코어 OS 원리와 구조 - Day 2</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">Created</span><span class="post-meta-item__value">2020-04-29</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">Updated</span><span class="post-meta-item__value">2020-12-11</span></span></div></header><div class="post-body"><blockquote>
<p>이 글은 ‘64비트 멀티코어 OS 원리와 구조 - 한승훈 저자’을 공부하며 정리한 내용을 작성했습니다.</p>
</blockquote>

        <h2 id="이미지-로딩-구현"   >
          <a href="#이미지-로딩-구현" class="heading-link"><i class="fas fa-link"></i></a><a href="#이미지-로딩-구현" class="headerlink" title="이미지 로딩 구현"></a>이미지 로딩 구현</h2>
      <p>책에서 구현하게 될 OS는 부트 로더, 보호 모드 커널, IA-32e 모드 커널로 구성되고 섹터 단위로 정렬되 하나의 부팅 이미지로 만들어지며 두 번째 섹터부터 읽어 메모리에 복사하면 이미지 로딩이 끝나게 된다. 책에서 구현하는 OS는 메모리 0x10000번지에 복사하게 되며, 이 주소는 정해진게 아니라 부트 로더 이후에 바로 복사해도 되지만, 책의 뒷장에서 0x10000 이하 번지를 다른 용도로 사용하기 위해서 비워둔다. </p>
<p>x86 프로세서는 스택과 관련된 레지스터가 3개 있는데 SS, SP, BP가 있다. 이때 SS를 어떻게 설정하느냐에 따라서 스택의 크기가 달라지는데 예를 들어 SS를 <code>0x0000</code>으로 설정한다면 <code>0x00000~0x0FFFF</code> SS를 <code>0x1000</code>으로 설정하면 <code>0x010000~0x01FFFF</code>까지 된다. 이렇게 SS를 통해서 스택의 범위를 지정할 순 있지만, 스택의 크기는 정하지 못하는데 32bit의 스택 한 칸의 크기는 4byte이다. </p>

        <h2 id="리얼-모드에서-보호-모드로의-전환"   >
          <a href="#리얼-모드에서-보호-모드로의-전환" class="heading-link"><i class="fas fa-link"></i></a><a href="#리얼-모드에서-보호-모드로의-전환" class="headerlink" title="리얼 모드에서 보호 모드로의 전환"></a>리얼 모드에서 보호 모드로의 전환</h2>
      <p>보호 모드로 전환하는 단계는 크게 6단계라고 할 수 있다. 2단계는 보호 모드 전환을 위한 자료구조 생성, 나머지 4단계는 생성된 자료구조를 프로세서에 설정을 한다. 2단계에서 생성할 필수 자료구조는 <code>세그먼트 디스크립터</code>와 <code>GDT</code>이다. 이 두 자료구조는 전환 즉시 프로세서에 의해 참조되므로 미리 생성해야 한다.</p>

        <h3 id="세그먼트-디스크립터-생성"   >
          <a href="#세그먼트-디스크립터-생성" class="heading-link"><i class="fas fa-link"></i></a><a href="#세그먼트-디스크립터-생성" class="headerlink" title="세그먼트 디스크립터 생성"></a>세그먼트 디스크립터 생성</h3>
      <p>세그먼트 디스크립터는 세그먼테이션 기법(메모리 관리 기법)에서 <code>세그먼트의 정보</code>를 나타내는 자료구조이다. 여기서 세그먼트는 메모리 공간을 <code>임의의 크기로 나눈 영역</code>을 의미한다. 세그먼트 디스크립터는 크게 <code>코드  세그먼트, 데이터 세그먼트 디스크립터</code>로 나뉜다. </p>
<ul>
<li>코드 세그먼트 : 실행가능한 코드가 포함된 세그먼트에 대한 정보 CS 세그먼트 셀렉터에 사용</li>
<li>데이터 세그먼트 : 데이터가 포함된 세그먼트에 대한 정보를 나타냄, CS를 제외한 나머지 세그먼트에 사용할 수 있음.</li>
</ul>
<blockquote>
<p>세그먼트 디스크립트 구조는 책의 사진이 더욱 이해하기 쉬워 연관된 필드를 작성하는 것으로 대체합니다.</p>
</blockquote>

        <h4 id="세그먼트-디스크립터-구조"   >
          <a href="#세그먼트-디스크립터-구조" class="heading-link"><i class="fas fa-link"></i></a><a href="#세그먼트-디스크립터-구조" class="headerlink" title="세그먼트 디스크립터 구조"></a>세그먼트 디스크립터 구조</h4>
      <ul>
<li>S, 타입 : S 필드로 세그먼트 디스크립트임을 표시하고, 타입 필드로 읽기/쓰기, 실행/읽기 으로 설정한다.</li>
<li>크기, G : 크기 필드는 총 20비트이며 최댓값은 1MB지만, 전체 4GB를 접근하기엔 무리가 있다. 따라서 G 필드를 활용해 1MB에 4KB가 곱해진 4GB에 접근할 수 있도록 한다.</li>
<li>D/B, L, 권한 : 기본 오퍼랜드 크기, 권한 설정</li>
<li>P, AVL : 기타 등등 ^^;;</li>
</ul>

        <h3 id="GDT"   >
          <a href="#GDT" class="heading-link"><i class="fas fa-link"></i></a><a href="#GDT" class="headerlink" title="GDT"></a>GDT</h3>
      <p>GDT(Global Descriptor Table)은 <code>연속된 디스크립터의 집합</code>이다. 앞서 코드 세그먼트 디스크립터와 데이터 세그먼트 디스크립터를 어셈블리어로 생성하였는데 이를 연속된 영역이 GDT이다. 다만 한 가지 제약이 있는데 가장 앞부분에 NULL 디스크립터를 추가해야한다는 점이다. NULL 디스크립터는 프로세서에 의해 예약된 모든 필드가 NULL(=0)인 디스크립터이다. 모든 값이 NULL이기에 일반적으론 참조되지 않는다.</p>
<p>GDT는 디스크립터의 집합이므로 디스크립터가 필요한 프로세서에게 GDT의 시작 주소와 크기를 알려줘야 한다. 따라서 <code>GDT의 시작주소, 크기 정보를 가지고 있는 자료구조(GDTR)</code>가 필요하게 된다.</p>
<p>32bit의 기준 주소 필드는 데이터 세그먼트의 기준 주소와 상관없이 0번째 주소를 기준으로 하는 선형 주소이다. 따라서 GDT의 시작 어드레스를 실제 메모리 공간상의 주소로 변환할 필요가 없다.</p>

        <h3 id="보호-모드로-전환"   >
          <a href="#보호-모드로-전환" class="heading-link"><i class="fas fa-link"></i></a><a href="#보호-모드로-전환" class="headerlink" title="보호 모드로 전환"></a>보호 모드로 전환</h3>
      <p>보호 모드로 전환하려면 GDTR 레지스터 설정, CR0 컨트롤 레지스터 설정, jmp 명령 수행 3단계만 수행하면 된다.</p>
<p>먼저 프로세서에 GDT 정보를 설정하려면 lgdt(load GDT) 명령어를 사용한다. lgdt는 앞서 어셈블리로 작성했던 <code>GDT의 시작 주소, GDT 크기</code>를 오퍼랜드로 받는다. 단 한 줄로 GDT가 로드된 것이다.</p>
<p>다음은, CR0 컨트롤 레지스터를 설정하는데 CR0 컨트롤 레지스터는 보호 모드 전환에 관련된 필드 외에 캐시, 페이징, 실수 연산 장치 등과 관련된 필드가 포함되어 있다. CR0 컨트롤 레지스터 또한 세그먼테이션 기능외에는 사용하지 않기에 책을 통해 확인하자.</p>
<p>앞서 리얼 모드에서 세그먼트 레지스터(aka. 세그먼트 셀렉터)는 세그먼트의 시작 주소를 저장하는 레지스터였다. 보호 모드의 세그먼트(세그먼트 레지스터 아님)는 리얼 모드와 달리 다양한 정보를 포함하고 있어 세그먼트 정보는 디스크립터에 저장하고, 세그먼트 레지스터(aka. 세그먼트 셀렉터)는 그 디스크립터를 지시하는 용도로 사용한다. <code>[세그먼트 레지스터] -&gt; [디스크립터(세그먼트 정보가 포함되어 있음.)]</code>와 같은 모양을 가지고 있다고 할 수 있다. 보호 모드 또한 세그먼트 셀렉터에 어드레스를 설정하여 GDT 내의 디스크립터를 참조한다. 다만, 세그먼트의 기준 주소 대신 <code>GDT 내의 디스크립터의 주소</code>를 사용한다. 예를 들어 NULL 디스크립터 다음의 커널 코드 세그먼트 디스크립터를 사용하고 싶다면, 디스크립터의 크기가 8byte임을 고려해 세그먼트 셀렉터에 <code>8</code>을 넣으면 된다. 요약하자면 주소가 아닌 오프셋으로 접근한다.</p>
<blockquote>
<p>EntryPoint.s 파일의 내용은 책 또는 공식 Github를 참고!</p>
</blockquote>
</div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ END ------</div></div><div class="post-copyright copyright"><div class="copyright-author"><span class="copyright-author__name">Author: </span><span class="copyright-author__value"><a href="https://blog.gomi.land">Byeongju Shin(aka. juraffe)</a></span></div><div class="copyright-link"><span class="copyright-link__name">Link: </span><span class="copyright-link__value"><a href="https://blog.gomi.land/2020/04/29/multicoreos64-day2/">https://blog.gomi.land/2020/04/29/multicoreos64-day2/</a></span></div><div class="copyright-notice"><span class="copyright-notice__name">Copyright: </span><span class="copyright-notice__value">All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" rel="external nofollow" target="_blank">BY-NC-SA</a> unless stating additionally</span></div></div><div class="post-tags"><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="https://blog.gomi.land/tags/os/">os</a></span><span class="post-tags-item"><span class="post-tags-item__icon"><i class="fas fa-tag"></i></span><a class="post-tags-item__link" href="https://blog.gomi.land/tags/kernel/">kernel</a></span></div><nav class="post-paginator paginator"><div class="paginator-prev"><a class="paginator-prev__link" href="/2020/04/30/archlinux-install/"><span class="paginator-prev__icon"><i class="fas fa-angle-left"></i></span><span class="paginator-prev__text">Arch linux 설치하기</span></a></div><div class="paginator-next"><a class="paginator-next__link" href="/2020/04/28/multicoreos64-day1/"><span class="paginator-prev__text">64bit 멀티코어 OS 원리와 구조 - Day 1</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">Catalog</span><span class="sidebar-nav-ov">Overview</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%EC%9D%B4%EB%AF%B8%EC%A7%80-%EB%A1%9C%EB%94%A9-%EA%B5%AC%ED%98%84"><span class="toc-number">1.</span> <span class="toc-text">
          이미지 로딩 구현</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EB%A6%AC%EC%96%BC-%EB%AA%A8%EB%93%9C%EC%97%90%EC%84%9C-%EB%B3%B4%ED%98%B8-%EB%AA%A8%EB%93%9C%EB%A1%9C%EC%9D%98-%EC%A0%84%ED%99%98"><span class="toc-number">2.</span> <span class="toc-text">
          리얼 모드에서 보호 모드로의 전환</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%EC%84%B8%EA%B7%B8%EB%A8%BC%ED%8A%B8-%EB%94%94%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%84%B0-%EC%83%9D%EC%84%B1"><span class="toc-number">2.1.</span> <span class="toc-text">
          세그먼트 디스크립터 생성</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%EC%84%B8%EA%B7%B8%EB%A8%BC%ED%8A%B8-%EB%94%94%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%84%B0-%EA%B5%AC%EC%A1%B0"><span class="toc-number">2.1.1.</span> <span class="toc-text">
          세그먼트 디스크립터 구조</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#GDT"><span class="toc-number">2.2.</span> <span class="toc-text">
          GDT</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%EB%B3%B4%ED%98%B8-%EB%AA%A8%EB%93%9C%EB%A1%9C-%EC%A0%84%ED%99%98"><span class="toc-number">2.3.</span> <span class="toc-text">
          보호 모드로 전환</span></a></li></ol></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/icons/stun-logo.svg" alt="avatar"></div><p class="sidebar-ov-author__text">hello world</p></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">16</div><div class="sidebar-ov-state-item__name">Archives</div></a></div><div class="sidebar-ov-cc"><a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.en" target="_blank" rel="noopener" data-popover="Creative Commons" data-popover-pos="up"><img src="/images/cc-by-nc-sa.svg"></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">You have read </span><span class="sidebar-reading-info__num">0</span><span class="sidebar-reading-info__perc">%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2021</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>Byeongju Shin(aka. juraffe)</span></div><div><span>Powered by <a href="http://hexo.io/" title="Hexo" target="_blank" rel="noopener">Hexo</a></span><span> v5.2.0</span><span class="footer__devider">|</span><span>Theme - <a href="https://github.com/liuyib/hexo-theme-stun/" title="Stun" target="_blank" rel="noopener">Stun</a></span><span> v2.6.2</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="/js/utils.js?v=2.6.2"></script><script src="/js/stun-boot.js?v=2.6.2"></script><script src="/js/scroll.js?v=2.6.2"></script><script src="/js/header.js?v=2.6.2"></script><script src="/js/sidebar.js?v=2.6.2"></script></body></html>